name: Build and test with coverage

on: [push]

jobs:
  Should-Build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: '6.0.x'
      - name: Install dependencies
        run: make restore 
      - name: Build
        run: make build-prod
  Should-Pass-Tests:
    runs-on: ubuntu-latest
    needs: Should-Build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: '6.0.x'
      - name: Install dependencies
        run: make restore 
      - name: Build
        run: make build-prod
      - name: Install coverage tool
        run: dotnet tool install --global dotnet-coverage 
      - name: Run tests
        run: make coverage
      - name: Upload artifact
        uses: actions/upload-artifact@master
        with:
          name: coverage
          path: ./output.cobertura.xml
  Upload-Coverage-To-Codecov:
    runs-on: ubuntu-latest
    needs: Should-Pass-Tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Download artifact
        uses: actions/download-artifact@master
        with:
          name: coverage
          path: ./
      - run: ls 
      - name: Upload coverage 
        uses: codecov/codecov-action@v2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./output.cobertura.xml
          verbose: true
